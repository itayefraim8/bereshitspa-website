<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title data-i18n="success.title">×”×ª×©×œ×•× ×”×¦×œ×™×—</title>

  <!-- âœ… ×©×™××•×© ×‘-CSS ×”×¨××©×™ ×©×œ×š (×›×•×œ×œ .status-card ×•×›×•') -->
  <link rel="stylesheet" href="styles.css">

  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body{font-family:Heebo,system-ui;max-width:780px;margin:40px auto;padding:0 16px}
    a{color:#2e7d32;font-weight:700;text-decoration:none}
    .lang-switch{display:flex;gap:8px;align-items:center;margin-bottom:16px}
    .visually-hidden{position:absolute!important;width:1px;height:1px;margin:-1px;border:0;padding:0;clip:rect(0 0 0 0);overflow:hidden}

    /* âœ… ×ª×•×¡×¤×ª: ×¢×™×¦×•×‘ ×§×•×¤×¡×ª ×¤×¨×˜×™ ×¢×¡×§×” */
    .payment-box{
      margin-top:24px;
      padding:16px 18px;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    .payment-box h2{
      margin:0 0 8px;
      font-size:1.1rem;
    }
    .payment-list{
      margin:0;
      padding:0;
    }
    .payment-list div{
      display:flex;
      gap:8px;
      margin:4px 0;
    }
    .payment-list dt{
      margin:0;
      min-width:120px;
      font-weight:600;
    }
    .payment-list dd{
      margin:0;
      flex:1;
    }
  </style>
</head>
<body>

  <!-- ğŸ”² ×§×•×¤×¡×ª ×¡×˜×˜×•×¡ ×™×•×§×¨×ª×™×ª ××”-CSS ×”×¨××©×™ (.status-card) -->
  <main class="status-card">

    <!-- ××ª×’ ×©×¤×” -->
    <div class="lang-switch" aria-label="Language">
      <label for="langSel" class="visually-hidden">Language</label>
      <select id="langSel">
        <option value="he">HE</option>
        <option value="en">EN</option>
        <option value="ru">RU</option>
        <option value="ka">KA</option>
      </select>
    </div>

    <!-- ×ª×•×›×Ÿ ×”×“×£ -->
    <h1 data-i18n="success.heading">âœ… ×”×ª×©×œ×•× ×”×¦×œ×™×—!</h1>
    <p data-i18n="success.desc">×ª×•×“×” ×¢×œ ×”×”×–×× ×” ×©×œ×š â€” ×”×§×‘×œ×” × ×©×œ×—×” ××œ×™×š ×‘××™×™×œ.</p>
    <p><a href="/" data-i18n="success.back_home">×—×–×¨×” ×œ×¢××•×“ ×”×¨××©×™</a></p>

    <!-- âœ… ×ª×•×¡×¤×ª: ×§×•×¤×¡×” ×œ×”×¦×’×ª ×¤×¨×˜×™ ×¢×¡×§×” -->
    <section id="paymentInfo" class="payment-box" style="display:none">
      <h2 id="paymentInfoTitle">×¤×¨×˜×™ ×¢×¡×§×”</h2>
      <div id="paymentInfoBody">
        <!-- ×™××•×œ× ×“×™× ××™×ª ××”×©×¨×ª ×œ×¤×™ session_id -->
      </div>
    </section>

  </main>

  <!-- ×¡× ×›×¨×•×Ÿ ×©×¤×”/×›×™×•×•× ×™×•×ª + ×ª×¨×’×•× -->
  <script>
    (function syncLangDir(){
      const lang=(localStorage.getItem('site_lang')||(navigator.language||'he')).slice(0,2);
      document.documentElement.lang=lang;
      document.documentElement.dir=(lang==='he'||lang==='ar')?'rtl':'ltr';
      const sel=document.getElementById('langSel');
      if(sel){
        sel.value=lang;
        sel.addEventListener('change',e=>{
          localStorage.setItem('site_lang',e.target.value);
          location.reload();
        });
      }
    })();

    (function i18nPage(){
      const map={
        'success.title'    :{ he:'×”×ª×©×œ×•× ×”×¦×œ×™×—', en:'Payment Successful', ru:'ĞŸĞ»Ğ°Ñ‚Ñ‘Ğ¶ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½', ka:'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ' },
        'success.heading'  :{ he:'âœ… ×”×ª×©×œ×•× ×”×¦×œ×™×—!', en:'âœ… Payment Successful!', ru:'âœ… ĞŸĞ»Ğ°Ñ‚Ñ‘Ğ¶ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½!', ka:'âœ… áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ!' },
        'success.desc'     :{ he:'×ª×•×“×” ×¢×œ ×”×”×–×× ×” ×©×œ×š â€” ×”×§×‘×œ×” × ×©×œ×—×” ××œ×™×š ×‘××™×™×œ.', en:'Thank you for your order â€” a receipt has been sent to your email.', ru:'Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾ Ğ·Ğ° Ğ·Ğ°ĞºĞ°Ğ· â€” ĞºĞ²Ğ¸Ñ‚Ğ°Ğ½Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ½Ğ° Ğ²Ğ°ÑˆÑƒ Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ.', ka:'áƒ’áƒ›áƒáƒ“áƒšáƒáƒ‘áƒ— áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ â€” áƒ¥áƒ•áƒ˜áƒ—áƒáƒ áƒ˜ áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒáƒ–áƒ” áƒ’áƒáƒ›áƒáƒ’áƒ˜áƒ’áƒ–áƒáƒ•áƒœáƒ”áƒ—.' },
        'success.back_home':{ he:'×—×–×¨×” ×œ×¢××•×“ ×”×¨××©×™', en:'Back to Home', ru:'ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ', ka:'áƒ›áƒ—áƒáƒ•Ğ°Ñ€ áƒ’áƒ•áƒ”áƒ áƒ“áƒ–áƒ” áƒ“áƒáƒ‘áƒ áƒ£áƒœáƒ”áƒ‘áƒ' }
      };
      const lang=(localStorage.getItem('site_lang')||'he').slice(0,2);
      document.title = map['success.title'][lang] || map['success.title'].he;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k=el.getAttribute('data-i18n');
        const v=(map[k]&&(map[k][lang]||map[k].he));
        if(v) el.textContent=v;
      });
    })();

    /* âœ… ×ª×•×¡×¤×ª: ×©×œ×™×¤×ª ×¤×¨×˜×™ Session ××”×©×¨×ª ×•×”×¦×’×” ×œ×œ×§×•×—
       ××•×ª×× ×œ× ×ª×™×‘ ×©×‘-server.js ×©×œ×š: GET /session?session_id=...
    */
    (function fillPaymentDetails(){
      const params = new URLSearchParams(location.search);
      const sessionId = params.get('session_id');
      const box   = document.getElementById('paymentInfo');
      const body  = document.getElementById('paymentInfoBody');
      const title = document.getElementById('paymentInfoTitle');

      if (!sessionId || !box || !body) return;

      // ×§×•×¤×¡×” × ×¨××™×ª
      box.style.display = 'block';

      const lang=(localStorage.getItem('site_lang')||'he').slice(0,2);
      const dict = {
        he:{
          title:'×¤×¨×˜×™ ×¢×¡×§×”',
          loading:'×˜×•×¢×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×â€¦',
          error:'×œ× ×”×¦×œ×—× ×• ×œ×˜×¢×•×Ÿ ××ª ×¤×¨×˜×™ ×”×ª×©×œ×•×. ×‘××™×“×ª ×”×¦×•×¨×š ×× × ×¤× ×” ××œ×™× ×• ×¢× ××•×¢×“ ×”×¢×¡×§×”.',
          kindBooking:'×”×–×× ×ª ×¢×™×¡×•×™ ×‘×¡×¤×',
          kindCart:'×”×–×× ×” ××”×—× ×•×ª',
          treatment:'×˜×™×¤×•×œ',
          customer:'×©× ×œ×§×•×—',
          phone:'×˜×œ×¤×•×Ÿ',
          date:'×ª××¨×™×š',
          time:'×©×¢×”',
          amount:'×¡×›×•×',
          currency:'××˜×‘×¢',
          notes:'×”×¢×¨×•×ª',
          paymentId:'××¡×¤×¨ ××™×©×•×¨ ×ª×©×œ×•×',
          email:'×“×•××´×œ'
        },
        en:{
          title:'Payment Details',
          loading:'Loading payment detailsâ€¦',
          error:'We could not load your payment details. Please contact us with the payment time if needed.',
          kindBooking:'Spa Treatment Booking',
          kindCart:'Shop Order',
          treatment:'Treatment',
          customer:'Customer',
          phone:'Phone',
          date:'Date',
          time:'Time',
          amount:'Amount',
          currency:'Currency',
          notes:'Notes',
          paymentId:'Payment ID',
          email:'Email'
        },
        ru:{
          title:'Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°',
          loading:'Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°â€¦',
          error:'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°. ĞŸÑ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑĞ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ½Ğ°Ğ¼Ğ¸, ÑƒĞºĞ°Ğ·Ğ°Ğ² Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹.',
          kindBooking:'Ğ‘Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¿Ğ°-Ğ¿Ñ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ñ‹',
          kindCart:'Ğ—Ğ°ĞºĞ°Ğ· Ğ¸Ğ· Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°',
          treatment:'ĞŸÑ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ğ°',
          customer:'ĞšĞ»Ğ¸ĞµĞ½Ñ‚',
          phone:'Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½',
          date:'Ğ”Ğ°Ñ‚Ğ°',
          time:'Ğ’Ñ€ĞµĞ¼Ñ',
          amount:'Ğ¡ÑƒĞ¼Ğ¼Ğ°',
          currency:'Ğ’Ğ°Ğ»ÑÑ‚Ğ°',
          notes:'ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ',
          paymentId:'ID Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°',
          email:'Email'
        },
        ka:{
          title:'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡ áƒ“áƒ”áƒ¢áƒáƒšáƒ”áƒ‘áƒ˜',
          loading:'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡ áƒ“áƒ”áƒ¢áƒáƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒâ€¦',
          error:'áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡ áƒ“áƒ”áƒ¢áƒáƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ. áƒ¡áƒáƒ­áƒ˜áƒ áƒáƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ—áƒ®áƒ•áƒ”áƒ•áƒáƒ¨áƒ˜ áƒ“áƒáƒ’áƒ•áƒ˜áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ“áƒ˜áƒ—.',
          kindBooking:'áƒ¡áƒáƒ áƒáƒ áƒáƒªáƒ”áƒ“áƒ£áƒ áƒ˜áƒ¡ áƒ“áƒáƒ¯áƒáƒ•áƒ¨áƒœáƒ',
          kindCart:'áƒ›áƒáƒ¦áƒáƒ–áƒ˜áƒ˜áƒ¡ áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ',
          treatment:'áƒáƒ áƒáƒªáƒ”áƒ“áƒ£áƒ áƒ',
          customer:'áƒ™áƒšáƒ˜áƒ”áƒœáƒ¢áƒ˜',
          phone:'áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜',
          date:'áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜',
          time:'áƒ“áƒ áƒ',
          amount:'áƒ—áƒáƒœáƒ®áƒ',
          currency:'áƒ•áƒáƒšáƒ£áƒ¢áƒ',
          notes:'áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ”áƒ‘áƒ˜',
          paymentId:'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒ¡ ID',
          email:'áƒ”áƒš.áƒ¤áƒáƒ¡áƒ¢áƒ'
        }
      };
      const L = dict[lang] || dict.he;

      if (title) title.textContent = L.title;
      body.textContent = L.loading;

      // âœ… ×©×™××•×© ×‘× ×ª×™×‘ ×©×”×’×“×¨×ª ×‘×©×¨×ª: /session?session_id=...
      fetch('/session?session_id=' + encodeURIComponent(sessionId))
        .then(res => {
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        })
        .then(data => {
          const s = data.session || data;
          if (!s) throw new Error('Missing session');

          const meta   = s.metadata || {};
          const isBooking = meta.type === 'treatment_booking';

          const amountTotal = typeof s.amount_total === 'number'
            ? (s.amount_total / 100)
            : (meta.finalPrice ? Number(meta.finalPrice) : null);

          const currency = (s.currency || 'gel').toUpperCase();

          const treatment =
            meta.treatment ||
            (s.line_items && s.line_items[0] && s.line_items[0].description) ||
            '';

          const name  = meta.name || (s.customer_details && s.customer_details.name) || '';
          const phone = meta.phone || (s.customer_details && s.customer_details.phone) || '';
          const email = (s.customer_details && s.customer_details.email) || '';
          const date  = meta.date || '';
          const time  = meta.time || '';
          const notes = meta.notes || '';
          const paymentId = typeof s.payment_intent === 'string'
            ? s.payment_intent
            : (s.payment_intent && s.payment_intent.id) || '';

          body.innerHTML = '';
          const kindP = document.createElement('p');
          kindP.textContent = isBooking ? L.kindBooking : L.kindCart;
          body.appendChild(kindP);

          const list = document.createElement('dl');
          list.className = 'payment-list';

          function addRow(label, value){
            if (!value) return;
            const row = document.createElement('div');
            const dt  = document.createElement('dt');
            const dd  = document.createElement('dd');
            dt.textContent = label + ':';
            dd.textContent = value;
            row.appendChild(dt);
            row.appendChild(dd);
            list.appendChild(row);
          }

          addRow(L.treatment, treatment);
          addRow(L.customer, name);
          addRow(L.phone, phone);
          addRow(L.email, email);
          addRow(L.date, date);
          addRow(L.time, time);
          if (amountTotal != null && !Number.isNaN(amountTotal)) {
            addRow(L.amount, amountTotal.toFixed(2) + ' ' + currency);
          }
          addRow(L.notes, notes);
          addRow(L.paymentId, paymentId);

          body.appendChild(list);
        })
        .catch(err => {
          console.error('load session details error:', err);
          body.textContent = (dict[lang] || dict.he).error;
        });
    })();
  </script>
</body>
</html>
