<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title data-i18n="success.title">התשלום הצליח</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body{font-family:Heebo,system-ui;max-width:780px;margin:40px auto;padding:0 16px}
    a{color:#2e7d32;font-weight:700;text-decoration:none}
    .lang-switch{display:flex;gap:8px;align-items:center;margin-bottom:16px}
    .visually-hidden{position:absolute!important;width:1px;height:1px;margin:-1px;border:0;padding:0;clip:rect(0 0 0 0);overflow:hidden}

    /* ✅ תוספת: עיצוב קופסת פרטי עסקה */
    .payment-box{
      margin-top:24px;
      padding:16px 18px;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    .payment-box h2{
      margin:0 0 8px;
      font-size:1.1rem;
    }
    .payment-list{
      margin:0;
      padding:0;
    }
    .payment-list div{
      display:flex;
      gap:8px;
      margin:4px 0;
    }
    .payment-list dt{
      margin:0;
      min-width:120px;
      font-weight:600;
    }
    .payment-list dd{
      margin:0;
      flex:1;
    }
  </style>
</head>
<body>

  <!-- מתג שפה -->
  <div class="lang-switch" aria-label="Language">
    <label for="langSel" class="visually-hidden">Language</label>
    <select id="langSel">
      <option value="he">HE</option>
      <option value="en">EN</option>
      <option value="ru">RU</option>
      <option value="ka">KA</option>
    </select>
  </div>

  <!-- תוכן הדף -->
  <h1 data-i18n="success.heading">✅ התשלום הצליח!</h1>
  <p data-i18n="success.desc">תודה על ההזמנה שלך — הקבלה נשלחה אליך במייל.</p>
  <p><a href="/" data-i18n="success.back_home">חזרה לעמוד הראשי</a></p>

  <!-- ✅ תוספת: קופסה להצגת פרטי עסקה -->
  <section id="paymentInfo" class="payment-box" style="display:none">
    <h2 id="paymentInfoTitle">פרטי עסקה</h2>
    <div id="paymentInfoBody">
      <!-- ימולא דינמית מהשרת לפי session_id -->
    </div>
  </section>

  <!-- סנכרון שפה/כיווניות + תרגום -->
  <script>
    (function syncLangDir(){
      const lang=(localStorage.getItem('site_lang')||(navigator.language||'he')).slice(0,2);
      document.documentElement.lang=lang;
      document.documentElement.dir=(lang==='he'||lang==='ar')?'rtl':'ltr';
      const sel=document.getElementById('langSel');
      if(sel){
        sel.value=lang;
        sel.addEventListener('change',e=>{
          localStorage.setItem('site_lang',e.target.value);
          location.reload();
        });
      }
    })();

    (function i18nPage(){
      const map={
        'success.title'    :{ he:'התשלום הצליח', en:'Payment Successful', ru:'Платёж выполнен', ka:'გადახდა წარმატებულია' },
        'success.heading'  :{ he:'✅ התשלום הצליח!', en:'✅ Payment Successful!', ru:'✅ Платёж выполнен!', ka:'✅ გადახდა წარმატებულია!' },
        'success.desc'     :{ he:'תודה על ההזמנה שלך — הקבלה נשלחה אליך במייל.', en:'Thank you for your order — a receipt has been sent to your email.', ru:'Спасибо за заказ — квитанция отправлена на вашу почту.', ka:'გმადლობთ შეკვეთისთვის — ქვითარი ელფოსტაზე გამოგიგზავნეთ.' },
        'success.back_home':{ he:'חזרה לעמוד הראשי', en:'Back to Home', ru:'На главную', ka:'მთავარ გვერდზე დაბრუნება' }
      };
      const lang=(localStorage.getItem('site_lang')||'he').slice(0,2);
      document.title = map['success.title'][lang] || map['success.title'].he;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k=el.getAttribute('data-i18n');
        const v=(map[k]&&(map[k][lang]||map[k].he));
        if(v) el.textContent=v;
      });
    })();

    /* ✅ תוספת: שליפת פרטי Session מהשרת והצגה ללקוח
       מצפה לנתיב backend: GET /checkout-session/:id
       שמחזיר את ה-Session (או JSON עם אותם שדות).
    */
    (function fillPaymentDetails(){
      const params = new URLSearchParams(location.search);
      const sessionId = params.get('session_id');
      const box   = document.getElementById('paymentInfo');
      const body  = document.getElementById('paymentInfoBody');
      const title = document.getElementById('paymentInfoTitle');

      if (!sessionId || !box || !body) return;

      // קופסה נראית
      box.style.display = 'block';

      const lang=(localStorage.getItem('site_lang')||'he').slice(0,2);
      const dict = {
        he:{
          title:'פרטי עסקה',
          loading:'טוען פרטי תשלום…',
          error:'לא הצלחנו לטעון את פרטי התשלום. במידת הצורך אנא פנה אלינו עם מועד העסקה.',
          kindBooking:'הזמנת עיסוי בספא',
          kindCart:'הזמנה מהחנות',
          treatment:'טיפול',
          customer:'שם לקוח',
          phone:'טלפון',
          date:'תאריך',
          time:'שעה',
          amount:'סכום',
          currency:'מטבע',
          notes:'הערות',
          paymentId:'מספר אישור תשלום',
          email:'דוא״ל'
        },
        en:{
          title:'Payment Details',
          loading:'Loading payment details…',
          error:'We could not load your payment details. Please contact us with the payment time if needed.',
          kindBooking:'Spa Treatment Booking',
          kindCart:'Shop Order',
          treatment:'Treatment',
          customer:'Customer',
          phone:'Phone',
          date:'Date',
          time:'Time',
          amount:'Amount',
          currency:'Currency',
          notes:'Notes',
          paymentId:'Payment ID',
          email:'Email'
        },
        ru:{
          title:'Данные платежа',
          loading:'Загружаем данные платежа…',
          error:'Не удалось загрузить данные платежа. При необходимости свяжитесь с нами, указав время оплаты.',
          kindBooking:'Бронирование спа-процедуры',
          kindCart:'Заказ из магазина',
          treatment:'Процедура',
          customer:'Клиент',
          phone:'Телефон',
          date:'Дата',
          time:'Время',
          amount:'Сумма',
          currency:'Валюта',
          notes:'Примечание',
          paymentId:'ID платежа',
          email:'Email'
        },
        ka:{
          title:'გადახდის დეტალები',
          loading:'გადახდის დეტალების ჩატვირთვა…',
          error:'ვერ მოხერხდა გადახდის დეტალების ჩატვირთვა. საჭიროების შემთხვევაში დაგვიკავშირდით.',
          kindBooking:'სპა პროცედურის დაჯავშნა',
          kindCart:'მაღაზიის შეკვეთა',
          treatment:'პროცედურა',
          customer:'კლიენტი',
          phone:'ტელეფონი',
          date:'თარიღი',
          time:'დრო',
          amount:'თანხა',
          currency:'ვალუტა',
          notes:'შენიშვნები',
          paymentId:'გადახდის ID',
          email:'ელ.ფოსტა'
        }
      };
      const L = dict[lang] || dict.he;

      if (title) title.textContent = L.title;
      body.textContent = L.loading;

      // ✅ שימוש בנתיב שהגדרנו בשרת: /checkout-session/:id
      fetch('/checkout-session/' + encodeURIComponent(sessionId))
        .then(res => {
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        })
        .then(data => {
          const s = data.session || data;
          if (!s) throw new Error('Missing session');

          const meta   = s.metadata || {};
          const isBooking = meta.type === 'treatment_booking';

          const amountTotal = typeof s.amount_total === 'number'
            ? (s.amount_total / 100)
            : (meta.finalPrice ? Number(meta.finalPrice) : null);

          const currency = (s.currency || 'gel').toUpperCase();

          const treatment =
            meta.treatment ||
            (s.line_items && s.line_items[0] && s.line_items[0].description) ||
            '';

          const name  = meta.name || (s.customer_details && s.customer_details.name) || '';
          const phone = meta.phone || (s.customer_details && s.customer_details.phone) || '';
          const email = (s.customer_details && s.customer_details.email) || '';
          const date  = meta.date || '';
          const time  = meta.time || '';
          const notes = meta.notes || '';
          const paymentId = typeof s.payment_intent === 'string'
            ? s.payment_intent
            : (s.payment_intent && s.payment_intent.id) || '';

          body.innerHTML = '';
          const kindP = document.createElement('p');
          kindP.textContent = isBooking ? L.kindBooking : L.kindCart;
          body.appendChild(kindP);

          const list = document.createElement('dl');
          list.className = 'payment-list';

          function addRow(label, value){
            if (!value) return;
            const row = document.createElement('div');
            const dt  = document.createElement('dt');
            const dd  = document.createElement('dd');
            dt.textContent = label + ':';
            dd.textContent = value;
            row.appendChild(dt);
            row.appendChild(dd);
            list.appendChild(row);
          }

          addRow(L.treatment, treatment);
          addRow(L.customer, name);
          addRow(L.phone, phone);
          addRow(L.email, email);
          addRow(L.date, date);
          addRow(L.time, time);
          if (amountTotal != null && !Number.isNaN(amountTotal)) {
            addRow(L.amount, amountTotal.toFixed(2) + ' ' + currency);
          }
          addRow(L.notes, notes);
          addRow(L.paymentId, paymentId);

          body.appendChild(list);
        })
        .catch(err => {
          console.error('load session details error:', err);
          body.textContent = (dict[lang] || dict.he).error;
        });
    })();
  </script>
</body>
</html>
