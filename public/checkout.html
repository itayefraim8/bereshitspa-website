<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-i18n="checkout.title">×ª×©×œ×•×</title>

  <!-- ×¤×•× ×˜ ×•×¢×™×¦×•×‘ ×›×œ×œ×™ (×›××• ×‘×¢××•×“ ×”×¨××©×™) -->
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="styles.css"/>

  <style>
    /* ××¢×˜ ×œ×™×˜×•×©×™× ××§×•××™×™× ×œ×“×£ ×”×ª×©×œ×•× */
    .summary-line{ display:flex; justify-content:space-between; gap:12px; padding:6px 0; border-bottom:1px solid #f1f5f9 }
    .summary-line:last-child{ border-bottom:0 }
    .summary-wrap{ display:grid; gap:8px }
    .summary-total{ display:flex; justify-content:space-between; font-weight:700; margin-top:8px }
    .visually-hidden{ position:absolute !important; width:1px; height:1px; margin:-1px; border:0; padding:0; clip:rect(0 0 0 0); overflow:hidden }
  </style>
</head>
<body>
  <!-- ×¤×¡ ×¢×œ×™×•×Ÿ (××—×™×“) -->
  <div class="topbar" role="note">ğŸšš <span data-i18n="topbar.free_ship">××©×œ×•×— ×—×™× × ××¢×œ 100â‚¾</span></div>

  <!-- Header ×§×¦×¨ ×¢× ×œ×•×’×• + ××ª×’ ×©×¤×” -->
  <header class="site-header">
    <div class="header-inner">
      <a href="index.html#home" class="brand" aria-label="×“×£ ×”×‘×™×ª">
        <img id="siteLogo" src="images/logo.png" alt="bergamot logo" class="logo"/>
      </a>

      <!-- âœ… ×”×•×¡×¤×ª×™ id="primary-nav" ×›×“×™ ×œ×”×ª××™× ×œ-script.js -->
      <nav id="primary-nav" class="main-nav" aria-label="× ×™×•×•×˜ ×¨××©×™">
        
        <div class="nav-item"><a class="navlink" href="index.html#home" data-i18n="nav.home">×“×£ ×”×‘×™×ª</a></div>
        <div class="nav-item"><a class="navlink" href="index.html#shop" data-i18n="nav.shop">×—× ×•×ª</a></div>
        <div class="nav-item"><a class="navlink" href="index.html#cart" data-i18n="nav.cart">×¢×’×œ×”</a></div>
        <div class="nav-item"><a class="navlink" href="index.html#contact" data-i18n="nav.contact">×¦×•×¨ ×§×©×¨</a></div>
      </nav>

      <!-- ××ª×’ ×©×¤×” -->
      <div class="lang-switch" aria-label="Language">
        <label for="langSel" class="visually-hidden">Language</label>
        <select id="langSel">
          <option value="he">HE</option>
          <option value="en">EN</option>
          <option value="ru">RU</option>
          <option value="ka">KA</option>
        </select>
      </div>

      <button class="nav-toggle" aria-controls="primary-nav" aria-expanded="false" aria-label="×¤×ª×—/×¡×’×•×¨ ×ª×¤×¨×™×˜">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
      </button>
    </div>
  </header>

  <main class="container">
    <!-- ===== ×ª×©×œ×•× ×œ×¤×™ ×¢×’×œ×” (×—× ×•×ª ××•×¦×¨×™×) ===== -->
    <section id="cartCheckoutSection" class="tabcontent" style="display:block">
      <h2 data-i18n="checkout.heading">×¡×™×›×•× ×”×–×× ×” ×•×ª×©×œ×•×</h2>
      <p class="muted" data-i18n="checkout.sub">×‘×“×•×§/×™ ××ª ×”×¤×¨×™×˜×™× ×•×”××©×™×›×• ×œ×ª×©×œ×•× ×××•×‘×˜×—.</p>

      <!-- ×¡×™×›×•× ×”×”×–×× ×” ××ª×•×š localStorage (×›××• ×‘×¢×’×œ×”) -->
      <div id="orderSummary" class="hero" aria-live="polite">
        <h3 data-i18n="checkout.summary">×¡×™×›×•×</h3>
        <div id="summaryList" class="summary-wrap"></div>
        <div class="summary-total">
          <span data-i18n="checkout.total">×¡×”×´×›</span>
          <span id="summaryTotal">â‚¾0</span>
        </div>
      </div>

      <div class="cta-row" style="margin-top:16px">
        <a id="backBtn" class="btn-outline" href="index.html#cart" data-i18n="checkout.back">×—×–×¨×” ×œ×¢×’×œ×”</a>
        <button id="payBtn" class="button" data-i18n="checkout.pay">×œ×ª×©×œ×•× ×‘×›×¨×˜×™×¡ ××©×¨××™</button>
      </div>

      <p class="muted" style="margin-top:12px" data-i18n="checkout.secure">×”×ª×©×œ×•× ××ª×‘×¦×¢ ×‘Ö¾Stripe, ×‘×¦×•×¨×” ×××•×‘×˜×—×ª.</p>
    </section>

    <!-- ===== ×”×–×× ×ª ×¢×™×¡×•×™ ××ª×¤×¨×™×˜ ×”×¡×¤× (book-btn) ===== -->
    <section id="treatmentCheckoutSection" class="tabcontent" style="display:none">
      <h2>×”×–×× ×ª ×¢×™×¡×•×™ ×•×ª×©×œ×•×</h2>
      <p class="muted">×‘×—×¨/×™ ××•×¢×“, ××œ×/×™ ×¤×¨×˜×™× ×•×”××©×™×›/×™ ×œ×ª×©×œ×•× ×¢×‘×•×¨ ×”×¢×™×¡×•×™ ×©× ×‘×—×¨.</p>

      <div class="hero">
        <div>×¢×™×¡×•×™ × ×‘×—×¨: <strong id="treat_name">â€”</strong></div>
        <div>
          ××—×™×¨ ×‘×¡×™×¡: <strong id="treat_base">0</strong>â‚¾
          <span id="treat_addon_wrap" style="display:none">
            &nbsp;|&nbsp; ××—×™×¨ ××•×¨×—×‘: <strong id="treat_addon">0</strong>â‚¾
          </span>
        </div>
        <div class="summary-total">
          <span>××—×™×¨ ×œ×—×™×•×‘</span>
          <span id="treat_final">â‚¾0</span>
        </div>
      </div>

      <form id="treat_form" style="margin-top:16px; max-width:480px">
        <div class="booking-row">
          <label>×©× ××œ×</label>
          <input type="text" name="name" required placeholder="×©× ×¤×¨×˜×™ ×•×©× ××©×¤×—×”">
        </div>

        <div class="booking-row">
          <label>×˜×œ×¤×•×Ÿ × ×™×™×“</label>
          <input type="tel" name="phone" required placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ×™×¦×™×¨×ª ×§×©×¨">
        </div>

        <div class="booking-row two-cols">
          <div>
            <label>×ª××¨×™×š ×¢×™×¡×•×™</label>
            <input type="date" name="date" required>
          </div>
          <div>
            <label>×©×¢×ª ×¢×™×¡×•×™</label>
            <input type="time" name="time" required>
          </div>
        </div>

        <div class="booking-row">
          <label>××©×š ×”×¢×™×¡×•×™</label>
          <div class="duration-options">
            <label>
              <input type="radio" name="durationOption" value="base" checked>
              ×‘×¡×™×¡×™
            </label>
            <label id="treat_addon_option" style="display:none">
              <input type="radio" name="durationOption" value="addon">
              ××•×¨×—×‘
            </label>
          </div>
        </div>

        <!-- âœ… ×××¦×¢×™ ×ª×©×œ×•× â€“ ×¨×§ ××•× ×œ×™×™×Ÿ, ×‘×œ×™ ×‘×—×™×¨×” ×‘××–×•××Ÿ -->
        <div class="booking-row">
          <label>×××¦×¢×™ ×ª×©×œ×•×</label>
          <div class="pay-methods">
            <span>×”×ª×©×œ×•× ××ª×‘×¦×¢ ×‘×›×¨×˜×™×¡ ××©×¨××™ ××•× ×œ×™×™×Ÿ ×‘×œ×‘×“.</span>
            <input type="hidden" name="payMethod" value="card">
          </div>
        </div>

        <div class="booking-row">
          <label>×”×¢×¨×•×ª × ×•×¡×¤×•×ª (××•×¤×¦×™×•× ×œ×™)</label>
          <textarea name="notes" rows="3" placeholder="×¨×’×™×©×•×™×•×ª, ×”×¢×“×¤×•×ª, ×”×¢×¨×•×ª ××™×•×—×“×•×ª"></textarea>
        </div>

        <button type="submit" class="button">
          ××™×©×•×¨ ×”×–×× ×” ×•×ª×©×œ×•×
        </button>
      </form>
    </section>
  </main>

  <footer class="site-footer" role="contentinfo">
    <div class="footer-grid">
      <div class="footer-title" data-i18n="footer.title">×¤×¨×˜×™ ×™×¦×™×¨×ª ×§×©×¨</div>
      <div>
        <span data-i18n="footer.phone">×˜×œ×¤×•×Ÿ:</span>
        <a href="tel:0502686862">0502686862</a> Â·
        <span data-i18n="footer.email">××™×™×œ:</span>info@bereshitspa.com</a>
        <a href="mailto:info@bereshitspa.com">

      </div>
      <div class="fb-cta">
        <strong data-i18n="footer.fb_title">×‘×§×¨×• ××•×ª× ×• ×‘×“×£ ×”×¤×™×™×¡×‘×•×§</strong><br/>
        <a class="button" href="https://www.facebook.com/profile.php?id=61583311067341" target="_blank" rel="noopener" data-i18n="footer.fb_btn">×œ×“×£ ×”×¤×™×™×¡×‘×•×§</a>
      </div>
    </div>
  </footer>

  <!-- ×§×‘×¦×™ ×”×¡×§×¨×™×¤×˜ ×”×›×œ×œ×™×™× ×©×œ ×”××ª×¨ ×©×œ×š -->
  <script src="script.js"></script>

  <!-- âœ… ×”×©×•×¨×” ×”××§×•×¨×™×ª ×©× ×©×œ×—×” â€“ × ×©××¨×” ×œ×œ× ×©×™× ×•×™ -->
  <script src="/payment.js"></script>

  <script>
    // ×¡× ×›×¨×•×Ÿ ×©×¤×”/×›×™×•×•× ×™×•×ª
    (function syncLangDir(){
      const lang = localStorage.getItem('site_lang') || (navigator.language||'he').slice(0,2);
      document.documentElement.lang = lang;
      document.documentElement.dir  = (lang === 'he' || lang === 'ar') ? 'rtl' : 'ltr';
      const sel = document.getElementById('langSel');
      if (sel) {
        sel.value = lang;
        sel.addEventListener('change', (e) => {
          localStorage.setItem('site_lang', e.target.value);
          location.reload();
        });
      }
    })();

    // ××™×œ×•×Ÿ ××§×•××™ ×œ×“×£ (× ×©×¢×Ÿ ×¢×œ ××•×ª×• ×¤×•×¨××˜ ×©×œ index)
    (function hydrateTexts(){
      const map = {
        'checkout.title':   { he:'×ª×©×œ×•×', en:'Checkout', ru:'ĞĞ¿Ğ»Ğ°Ñ‚Ğ°', ka:'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ' },
        'checkout.heading': { he:'×¡×™×›×•× ×”×–×× ×” ×•×ª×©×œ×•×', en:'Order Summary & Payment', ru:'Ğ¡Ğ²Ğ¾Ğ´ĞºĞ° Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°', ka:'áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ˜áƒ¡ áƒ¨áƒ”áƒ¯áƒáƒ›áƒ”áƒ‘áƒ áƒ“áƒ áƒ’áƒáƒ“áƒáƒ®áƒáƒ“áƒ' },
        'checkout.sub':     { he:'×‘×“×•×§/×™ ××ª ×”×¤×¨×™×˜×™× ×•×”××©×™×›×• ×œ×ª×©×œ×•× ×××•×‘×˜×—.', en:'Review your items and proceed to secure payment.', ru:'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ¸ Ğ¿ĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğº Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ.', ka:'áƒ’áƒáƒ“áƒáƒ®áƒ”áƒ“áƒ”áƒ— áƒœáƒ˜áƒ•áƒ—áƒ”áƒ‘áƒ¡ áƒ“áƒ áƒ’áƒáƒ˜áƒáƒ áƒ”áƒ— áƒ£áƒ¡áƒáƒ¤áƒ áƒ—áƒ®áƒ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ.' },
        'checkout.summary': { he:'×¡×™×›×•×', en:'Summary', ru:'Ğ¡Ğ²Ğ¾Ğ´ĞºĞ°', ka:'áƒ¨áƒ”áƒ¯áƒáƒ›áƒ”áƒ‘áƒ' },
        'checkout.total':   { he:'×¡×”×´×›', en:'Total', ru:'Ğ˜Ñ‚Ğ¾Ğ³Ğ¾', ka:'áƒ¯áƒáƒ›áƒ˜' },
        'checkout.back':    { he:'×—×–×¨×” ×œ×¢×’×œ×”', en:'Back to Cart', ru:'ĞĞ°Ğ·Ğ°Ğ´ Ğ² ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ', ka:'áƒ£áƒ™áƒáƒœ áƒ™áƒáƒšáƒáƒ—áƒáƒ¨áƒ˜' },
        'checkout.pay':     { he:'×œ×ª×©×œ×•× ×‘×›×¨×˜×™×¡ ××©×¨××™', en:'Pay by Card', ru:'ĞĞ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ğ¾Ğ¹', ka:'áƒ‘áƒáƒ áƒáƒ—áƒ˜áƒ— áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ' },
        'checkout.secure':  { he:'×”×ª×©×œ×•× ××ª×‘×¦×¢ ×‘Ö¾Stripe, ×‘×¦×•×¨×” ×××•×‘×˜×—×ª.', en:'Payment is processed securely via Stripe.', ru:'ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· Stripe.', ka:'áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ áƒ£áƒ¡áƒáƒ¤áƒ áƒ—áƒ®áƒáƒ“ áƒ›áƒ£áƒ¨áƒáƒ•áƒ“áƒ”áƒ‘áƒ Stripe-áƒ˜áƒ¡ áƒ¡áƒáƒ¨áƒ£áƒáƒšáƒ”áƒ‘áƒ˜áƒ—.' },
        'topbar.free_ship': { he:'××©×œ×•×— ×—×™× × ××¢×œ â‚¾399', en:'Free shipping over â‚¾399', ru:'Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ°Ñ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ° Ğ¾Ñ‚ â‚¾399', ka:'áƒ£áƒ¤áƒáƒ¡áƒ áƒ›áƒ˜áƒ¢áƒáƒœáƒ â‚¾399â€“áƒ–áƒ” áƒ–áƒ”áƒ›áƒáƒ—' },
        'nav.shop':         { he:'×—× ×•×ª', en:'Shop', ru:'ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½', ka:'áƒ›áƒáƒ¦áƒáƒ–áƒ˜áƒ' },
        'nav.cart':         { he:'×¢×’×œ×”', en:'Cart', ru:'ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ°', ka:'áƒ™áƒáƒšáƒáƒ—áƒ' },
        'nav.contact':      { he:'×¦×•×¨ ×§×©×¨', en:'Contact', ru:'ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹', ka:'áƒ™áƒáƒœáƒ¢áƒáƒ¥áƒ¢áƒ˜' },
        'footer.title':     { he:'×¤×¨×˜×™ ×™×¦×™×¨×ª ×§×©×¨', en:'Contact Details', ru:'ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹', ka:'áƒ¡áƒáƒ™áƒáƒœáƒ¢áƒáƒ¥áƒ¢áƒ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ' },
        'footer.phone':     { he:'×˜×œ×¤×•×Ÿ:', en:'Phone:', ru:'Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½:', ka:'áƒ¢áƒ”áƒš:' },
        'footer.email':     { he:'××™×™×œ:', en:'Email:', ru:'Email:', ka:'áƒ”áƒš.áƒ¤áƒáƒ¡áƒ¢áƒ:' },
        'footer.fb_title':  { he:'×‘×§×¨×• ××•×ª× ×• ×‘×“×£ ×”×¤×™×™×¡×‘×•×§', en:'Visit our Facebook page', ru:'ĞŸĞ¾ÑĞµÑ‚Ğ¸Ñ‚Ğµ Ğ½Ğ°ÑˆÑƒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ² Facebook', ka:'áƒ”áƒ¬áƒ•áƒ˜áƒ”áƒ— áƒ©áƒ•áƒ”áƒœáƒ¡ Facebook áƒ’áƒ•áƒ”áƒ áƒ“áƒ¡' },
        'footer.fb_btn':    { he:'×œ×“×£ ×”×¤×™×™×¡×‘×•×§', en:'Open Facebook', ru:'ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Facebook', ka:'Facebook áƒ’áƒ•áƒ”áƒ áƒ“áƒ˜' }
      };
      const lang = (localStorage.getItem('site_lang')||'he');
      document.title = (map['checkout.title'][lang] || map['checkout.title'].he);
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        const v = (map[k] && (map[k][lang] || map[k].he)) || el.textContent;
        el.textContent = v;
      });
    })();

    // ×¨×™× ×“×•×¨ ×¡×™×›×•× ××”×¢×’×œ×” + ×—×™×‘×•×¨ ×”×›×¤×ª×•×¨ ×œ-payWithCard ×”×§×™×™××ª
    (function renderSummary(){
      const LS_KEY='bergamot_cart';
      const toILS = (n)=>`â‚¾${Number(n).toFixed(0)}`;
      let cart = [];
      try { cart = JSON.parse(localStorage.getItem(LS_KEY)) || []; } catch { cart = []; }

      const list = document.getElementById('summaryList');
      const totalEl = document.getElementById('summaryTotal');
      list.innerHTML = '';
      let sum = 0;

      if (!Array.isArray(cart) || cart.length===0) {
        const p = document.createElement('p');
        p.className='muted';
        const lang = (localStorage.getItem('site_lang')||'he');
        const emptyMap = { he:'×”×¢×’×œ×” ×¨×™×§×”.', en:'Your cart is empty.', ru:'ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ° Ğ¿ÑƒÑÑ‚Ğ°.', ka:'áƒ™áƒáƒšáƒáƒ—áƒ áƒªáƒáƒ áƒ˜áƒ”áƒšáƒ˜áƒ.' };
        p.textContent = emptyMap[lang] || emptyMap.he;
        list.appendChild(p);
      } else {
        cart.forEach(it=>{
          const line = document.createElement('div'); line.className='summary-line';
          const left = document.createElement('span'); left.textContent = `${it.title} Ã— ${it.qty}`;
          const right = document.createElement('span'); right.textContent = toILS(it.price * it.qty);
          line.append(left, right); list.appendChild(line);
          sum += it.price * it.qty;
        });
      }
      totalEl.textContent = toILS(sum);

      // ×›×¤×ª×•×¨ ×ª×©×œ×•×
      document.getElementById('payBtn')?.addEventListener('click', ()=>{
        if (typeof window.payWithCard === 'function') return window.payWithCard();
        // fallback: ×× ××™×Ÿ payWithCard (×××•×¨ ×œ×”×™×•×ª ×‘-script.js), × ×—×–×•×¨ ×œ×¢×’×œ×”
        location.href = 'index.html#cart';
      });
    })();

    // âœ… ××¦×‘ ×”×–×× ×ª ×¢×™×¡×•×™ ××ª×¤×¨×™×˜ ×”×¡×¤× (book-btn â†’ localStorage.bereshit_booking)
    (function setupTreatmentCheckout(){
      const bookingRaw = localStorage.getItem('bereshit_booking');
      if (!bookingRaw) return;

      let booking;
      try { booking = JSON.parse(bookingRaw); } catch(e){ return; }

      const cartSection  = document.getElementById('cartCheckoutSection');
      const treatSection = document.getElementById('treatmentCheckoutSection');
      if (!treatSection) return;

      // ××¡×ª×™×¨×™× ××ª checkout ×©×œ ×”×¢×’×œ×”, ××¦×™×’×™× ××ª ×“×£ ×”×¢×™×¡×•×™
      if (cartSection) cartSection.style.display = 'none';
      treatSection.style.display = 'block';

      const nameEl    = document.getElementById('treat_name');
      const baseEl    = document.getElementById('treat_base');
      const addonEl   = document.getElementById('treat_addon');
      const addonWrap = document.getElementById('treat_addon_wrap');
      const finalEl   = document.getElementById('treat_final');
      const addonOpt  = document.getElementById('treat_addon_option');
      const form      = document.getElementById('treat_form');

      let basePrice  = Number(booking.base || 0);
      let addonPrice = Number(booking.addon || 0);

      if (nameEl)  nameEl.textContent  = booking.treatment || '×¢×™×¡×•×™ ×‘×¡×¤×';
      if (baseEl)  baseEl.textContent  = basePrice.toString();
      if (addonEl) addonEl.textContent = addonPrice.toString();

      if (addonPrice > 0) {
        if (addonWrap) addonWrap.style.display = '';
        if (addonOpt)  addonOpt.style.display  = '';
      }

function updateFinal(){
  if (!finalEl || !form) return;
  const chosen = (form.querySelector('input[name="durationOption"]:checked') || {}).value || 'base';

  let final;
  if (chosen === 'addon' && addonPrice > 0) {
    // ×× ×”-addon ×§×˜×Ÿ ××”-base â€“ × × ×™×— ×©×”×•× "×ª×•×¡×¤×ª" (delta) ×•× ×—×‘×¨.
    // ×× ×”×•× ×’×“×•×œ/×©×•×•×” â€“ × × ×™×— ×©×”×•× ××—×™×¨ ××œ× ×œ×’×¨×¡×” ×”××•×¨×—×‘×ª.
    final = (addonPrice >= basePrice) ? addonPrice : (basePrice + addonPrice);
  } else {
    final = basePrice;
  }

  finalEl.textContent = `â‚¾${final}`;
}

      if (form){
        // ×ª××¨×™×š ××™× ×™××œ×™ â€“ ×”×™×•×
        const today = new Date().toISOString().slice(0,10);
        const dateInput = form.querySelector('input[name="date"]');
        if (dateInput) dateInput.min = today;

        form.querySelectorAll('input[name="durationOption"]').forEach(r=>{
          r.addEventListener('change', updateFinal);
        });

        updateFinal();

        /* âœ… ×©×™× ×•×™ ×™×—×™×“: ×—×™×‘×•×¨ ×”×˜×•×¤×¡ ×œ× ×ª×™×‘ create-booking-session ×‘×©×¨×ª ×•×©×œ×™×—×” ×œ-Stripe */
        form.addEventListener('submit', async function(e){
          e.preventDefault();
          const fd = new FormData(form);
          const duration = fd.get('durationOption') || 'base';
          const finalStr = finalEl ? finalEl.textContent.replace(/[^\d.]/g,'') : basePrice;
          const finalPrice = Number(finalStr || basePrice || 0);

          const payload = {
            treatment: booking.treatment || '×¢×™×¡×•×™ ×‘×¡×¤×',
            basePrice,
            addonPrice,
            duration,
            finalPrice,
            name:  fd.get('name')  || '',
            phone: fd.get('phone') || '',
            date:  fd.get('date')  || '',
            time:  fd.get('time')  || '',
            notes: fd.get('notes') || ''
          };

          console.log('Treatment booking (send to server):', payload);

          try {
            const resp = await fetch('http://localhost:4242/create-booking-session', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const raw = await resp.text();
            let data = {};
            try { data = raw ? JSON.parse(raw) : {}; } catch(e){}

            if (!resp.ok) {
              const msg = (data && data.error && data.error.message) || `×©×’×™××” ×‘×©×¨×ª (×¡×˜×˜×•×¡ ${resp.status})`;
              alert('××™×¨×¢×” ×©×’×™××” ×‘×™×¦×™×¨×ª ×ª×©×œ×•×: ' + msg);
              return;
            }

            if (data && data.url) {
              // ××¢×‘×¨ ×œ××¡×š ×”×ª×©×œ×•× ×©×œ Stripe
              window.location.href = data.url;
            } else {
              alert('×œ× ×”×ª×§×‘×œ×” ×›×ª×•×‘×ª ×ª×©×œ×•× ××”×©×¨×ª.');
            }
          } catch (err) {
            console.error('Treatment pay error:', err);
            alert('××™×¨×¢×” ×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª. × ×¡×”/×™ ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.');
          }
        });
      }
    })();
  </script>
</body>
</html>
